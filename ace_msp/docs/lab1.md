# Lab 1 - Build the MSP Backbone

## 1.0 - What is in the lab?

This is an advanced scenario for **Managed Service Providers** (MSPs) that goes through onboarding Tenants, connecting to their respective locations, overlapping addresses and much more.

```{note}
The initial lab topology can be found below and consists of:
- <ins>Shared Services</ins> spread across AWS & Azure with their respective Spoke Gateways.
- <ins>Backbone layer</ins> spread across AWS & Azure. The PAN FWs have already been pre-built in AWS. In a subsequent lab, you will be building the same within Azure.
- **3** Separate Tenants (customers-a, b and c). Customers in tandem with the MSPs can host their applications and services within their dedicated & isolated space. Though we represent each customer with a single VPC, in reality the same design can scale to cater multiple VPCs, Regions, and Accounts. 
- **Customer Locations**: These represent locations outside the Public Cloud(s) that need connectivity to the applications and services within the Public Cloud(s).
- There are **workloads** spread across the topology running an NGINX server & proxy which will be used to test end to end connectivity.
```

![Lab Overview](images/lab1/lab1-topology.png)
_Figure 1: Lab Overview_

## 1.1 - Initial Topology

Go to **CoPilot > Settings > Resources > Task Server**

  - Ensure that both **Fetch GW Routes** and **Fetch VPC Routes** intervals are set to <ins>“1 second”</ins> each and then click on **SAVE**.

![Task Server](images/lab1/lab1-task.png)
_Figure 2: Task Server_

![GW routes](images/lab1/lab1-task2.png)
_Figure 3: Fetch GW Routes_

![VPC routes](images/lab1/lab1-task3.png)
_Figure 4: Fetch VPC Routes_

Afterwards, click on **Commit**.

![Commit](images/lab1/lab1-task4.png)
_Figure 5: Commit_

```{warning}
These are very aggressive settings. In a Production environment, you should not set these intervals that frequently!
```

- Let's visit our **Topology** page within CoPilot by leveraging the *Search Bar* as shown below.

![Search Bar](images/lab1/lab1-topocopilot.png)
_Figure 6: Using the Search Bar_

- Click on the **Legend** button in order to get a drop-down window with all the icon simbols.

![Legend](images/lab1/lab1-topocopilot2.png)_Figure 7: Topology Legend_

## 1.2 - Build the MSP Backbone

Having looked at the initial overall topology we will focusing on the **Transit Core Backbone** area for this lab. The initial status of the backbone area is as shown here.

- Pairs of gateways of the same flavor (i.e. either Transit or Spoke gateways) have the inter-link <ins>auto generated by the Controller</ins> (this attachment has a metric of **200**).
- The peerings between the pair of Transit GWs and the attachments between the Spoke GWs and their corresponding Transit GWs <ins>need to be deployed</ins>.

![Backbone Area](images/lab1/lab1-initialbackbone.png)_Figure 8: Initial Backbone_

### 1.2.1 - Connect AWS Shared SVCs to AWS Hub

- Establish the **attachments** between the  Spoke Gateways and the Transit Gateways in **AWS**.

```{tip}
Go to **CoPilot > Cloud Fabric > Gateways > Spoke Gateways** and select the *aws-shared-svcs* GWs cluster and then click on the **pencil icon** for editing that specific cluster.
```

![Edit Spoke in AWS](images/lab1/lab1-edit.png)_Figure 9: Edit the Spoke GW in AWS_

```{tip}
Click on the *"Attach to Transit Gateway"* drop-down window and select the *aws-hub GW* and then click on **Save**.
```

![Select aws-hub](images/lab1/lab1-edit2.png)_Figure 10: Select aws-hub for establishing the peering_

### 1.2.2 - Connect Azure Shared SVCs to Azure Hub

- Establish the **attachments** between the  Spoke Gateways and the Transit Gateways in **Azure**.

```{tip}
Go to **CoPilot > Cloud Fabric > Gateways > Spoke Gateways** and select this time the *azure-shared-svcs* GWs cluster and then click on the **pencil icon** for editing that specific cluster.
```

![Edit Spoke in Azure](images/lab1/lab1-azureedit.png)_Figure 11: Edit the Spoke GW in Azure_

```{tip}
Click on the *"Attach to Transit Gateway"* drop-down window and select the *azure-hub GW* and then click on **Save**.
```

![Select azure-hub](images/lab1/attach_azure_shared_svcs_to_aws_hub.png)_Figure 12: Select azure-hub for establishing the peering_

## 1.2.3 - Configure Transit Peering between AWS & Azure

- Establish the **peerings** between the  Transit Gateways in **AWS** and the Transit Gateways in **Azure**.

```{tip}
Go to **CoPilot > Cloud Fabric > Gateways > Transit Gateways** and select the *aws-hub* GWs cluster and then click on the **pencil icon** for editing that specific cluster.
```

![Select aws-hub](images/lab1/lab1-edititransit.png)_Figure 13: Edit AWS Hub Transits_

```{tip}
Click on the *"Peer to Transit Gateway"* drop-down window and select the *azure-hub GW* and then click on **Save**.
```

![Configure Peering with Azure Hub](images/lab1/lab1-edittransit2.png)_Figure 14: Select azure-hub for establishing the peering_

##  1.3 - Verification of Attachments & Peerings

- Verify the *aws-shared-svcs* Spoke Cluster.

```{tip}
Go to **CoPilot > Cloud Fabric > Gateways > Spoke Gateways**, select the *aws-shared-svcs* Spoke GWs cluster and then select the **Connections TAB**.
```

- Check the **Backup peering** (default tab). You will notice one single peering between the *aws-shared-svcs GW* and the *aws-shared-svcs-hagw GW*.

```{note}
This peering is auto generated by the Aviatrix Controller.
```
  
![The backup peering](images/lab1/lab1-backuppeering.png)_Figure 15: The Backup Peering_

- Check the **Transit-Spoke peering** tab. You will notice **four** peerings between the *aws-hub GWs Cluster* and the *azure-hub GWs Cluster*.

![AThe tranist-Spoke peering or attachment](images/lab1/lab1-establishment.png)_Figure 16: AWS & Azure Hub Peering Verification_

- Check the Topology.

```{note}
Go to **CoPilot > Topology > Overview (default TAB)**.
```

![Topology Verification](images/lab1/lab1-topologycopilot.png)_Figure 17: Topology Verification_

At this point, this is how the overall topology would look like:

![Current Topology](images/lab1/lab1-topology2.png)_Figure 18: Current State of the Topology_

## 1.4 Data Plane Verification

- Retrieve the IP address.

![Instance IPs](images/lab1/find_ip_address_of_machine.png)_Figure 16: Find Instance IP Address_


![Ping Verification](images/lab1/ping_from_aws_log1_to_azure_log1.png)_Figure 17: Ping Verification_

![Browser Verification](images/lab1/web_browser_to_aws_log1.png)_Figure 18: Access aws-log1 Application_

![Browser Verification](images/lab1/web_browser_to_azure_log1_through_aws_log1.png)_Figure 19: Verification Leveraging NGINX Proxy_

##  1.5 - Conclusion
In this lab, we have built our MSP backbone layer and ensured end to end connectivity across the MSP. 
