

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Lab 7 Security Enhancements &#8212; ACE Multicloud Network for Managed Service Providers</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=365ca57ee442770a23c6"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'docs/lab7';</script>
    <link rel="shortcut icon" href="../_static/aviatrix-favicon-32.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Lab 6 Advanced Routing &amp; Resiliency" href="lab6.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="home.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/aviatrix-logo.png" class="logo__image only-light" alt="ACE Multicloud Network for Managed Service Providers - Home"/>
    <script>document.write(`<img src="../_static/aviatrix-logo.png" class="logo__image only-dark" alt="ACE Multicloud Network for Managed Service Providers - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="home.html">
                    Welcome to ACE MSP instructor-led training!
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lab1.html">Lab 1 - Build the MSP Backbone</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab2.html">Lab 2 Customer Isolation</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab3.html">Lab 3 FireNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab4.html">Lab 4 Site2Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab5.html">Lab 5 Advanced NAT Scenarios</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab6.html">Lab 6 Advanced Routing &amp; Resiliency</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lab 7 Security Enhancements</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/docs/lab7.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lab 7 Security Enhancements</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-s-in-the-lab">7.0 - What’s in the lab?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#distributed-firewalling-inter-vpc-vnet">7.1 - Distributed Firewalling (Inter-VPC/VNET)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#smart-group-creation">7.1.1  - Smart Group Creation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-dfw-connectivity-test">7.1.2  - Pre-DFW Connectivity Test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distributed-firewall-rule">7.1.3  - Distributed Firewall Rule</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#zooming-in-on-the-dfw-rule">7.1.4  - Zooming in on the DFW Rule</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#distributed-firewalling-intra-vnet">7.2 - Distributed Firewalling (Intra-VNET)</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lab-7-security-enhancements">
<h1>Lab 7 Security Enhancements<a class="headerlink" href="#lab-7-security-enhancements" title="Permalink to this heading">#</a></h1>
<section id="what-s-in-the-lab">
<h2>7.0 - What’s in the lab?<a class="headerlink" href="#what-s-in-the-lab" title="Permalink to this heading">#</a></h2>
<p>In this lab we will mainly explore a subset of the security features that the platform provides. We will start with Distributed Firewalling where the source and destination are in two different VPCs to Intra-VNET segmentation and finally end with a quick configuration of ThreatIQ.</p>
<p><img alt="Current Topology" src="docs/images/lab1/Backbone_Area_Configured.png" /><em>Figure 1: Current State of the Topology</em></p>
</section>
<section id="distributed-firewalling-inter-vpc-vnet">
<h2>7.1 - Distributed Firewalling (Inter-VPC/VNET)<a class="headerlink" href="#distributed-firewalling-inter-vpc-vnet" title="Permalink to this heading">#</a></h2>
<section id="smart-group-creation">
<h3>7.1.1  - Smart Group Creation<a class="headerlink" href="#smart-group-creation" title="Permalink to this heading">#</a></h3>
<p><img alt="Navigate to Smart Groups" src="docs/images/lab7/Navigate_to_SmartGroups.png" />
<em>Figure 2: Navigate to Smart Groups</em></p>
<p><img alt="Create Smart Group Aws-log1" src="docs/images/lab7/New_SG_creation_aws_log1.png" /><em>Figure 3: Create Smart Group Aws-log1</em></p>
<p><img alt="Create Smart Group Azure-log1" src="docs/images/lab7/New_SG_creation_azure_log1.png" /><em>Figure 4: Create Smart Group Azure-log1</em></p>
<p><img alt="Create Smart Group Azure-log2" src="docs/images/lab7/New_SG_creation_azure_log2.png" /><em>Figure 5: Create Smart Group Azure-log2</em></p>
<p><img alt="AWS-Log1 SmartGroup Resource Matching" src="../_images/aws_log1_resource_matching.png" /><em>Figure 6: AWS-Log1 SmartGroup Resource Matching</em></p>
<p><img alt="Azure-Log1 SmartGroup Resource Matching" src="../_images/azure_log1_resource_matching.png" /><em>Figure 7: Azure-Log1 SmartGroup Resource Matching</em></p>
<p><img alt="Azure-Log2 SmartGroup Resource Matching" src="../_images/azure_log2_resource_matching.png" /><em>Figure 8: Azure-Log2 SmartGroup Resource Matching</em></p>
</section>
<section id="pre-dfw-connectivity-test">
<h3>7.1.2  - Pre-DFW Connectivity Test<a class="headerlink" href="#pre-dfw-connectivity-test" title="Permalink to this heading">#</a></h3>
<p>Before any DFW rules, let us check the connectivity from aws-log1 to azure-log1 &amp; azure-log2 leveraging ping and the proxy.</p>
<p><img alt="Ping from aws-log1 to azure-log1" src="docs/images/lab7/Pre_DFW_ping_from_aws_log1_to_azure_log1.png" /><em>Figure 9: Ping from aws-log1 to azure-log1</em></p>
<p><img alt="Ping from aws-log1 to azure-log1" src="docs/images/lab7/Pre_DFW_Proxy_from_aws_log1_to_azure_log1.png" /><em>Figure 10: Proxy from aws-log1 to azure-log1</em></p>
<p><img alt="Ping from aws-log1 to azure-log2" src="docs/images/lab7/Pre_DFW_ping_from_aws_log1_to_azure_log2.png" /><em>Figure 11: Ping from aws-log1 to azure-log2</em></p>
<p><img alt="Proxy from aws-log1 to azure-log2" src="docs/images/lab7/Pre_DFW_proxy_from_aws_log1_to_azure_log2.png" /><em>Figure 12: Proxy from aws-log1 to azure-log2</em></p>
</section>
<section id="distributed-firewall-rule">
<h3>7.1.3  - Distributed Firewall Rule<a class="headerlink" href="#distributed-firewall-rule" title="Permalink to this heading">#</a></h3>
<p>Let’s start by enabling Distributed Firewalling.</p>
<p><img alt="Navigate to DFW" src="docs/images/lab7/Navigate_to_Distributed_FW.png" /><em>Figure 13: Navigate to Distributed Firewalling</em></p>
<p><img alt="Enable DFW" src="docs/images/lab7/Enable_Distributed_FW.png" /><em>Figure 14: Enable Distributed Firewalling</em></p>
<p>Now that we have enabled Distributed Firewalling, the next step is to put a rule that locks down the communication from aws-log1 to azure-log1 to be only HTTP.</p>
<p><img alt="Rule aws-log1 to azure-log1 tcp port 80" src="docs/images/lab7/A_aws_log1_azure_log1_p80_p1.png" /><em>Figure 15: Rule aws-log1 to azure-log1 tcp port 80 Part 1</em></p>
<p><img alt="Azure-Log2 SmartGroup Resource Matching" src="docs/images/lab7/A_aws_log1_azure_log1_p80_p2.png" /><em>Figure 16: Rule aws-log1 to azure-log1 tcp port 80 Part 2</em></p>
</section>
<section id="zooming-in-on-the-dfw-rule">
<h3>7.1.4  - Zooming in on the DFW Rule<a class="headerlink" href="#zooming-in-on-the-dfw-rule" title="Permalink to this heading">#</a></h3>
<p>In the previous section, we just put a rule allowing HTTP traffic only from aws-log1 to azure-log1. Note that because the source and destination are in different VPC/VNETs the rules are applied on the gateways. The intelligence of the solution allows you to write a rule and the system decides where to enforce the rule (Gateway or NSGs in Azure).</p>
<p><img alt="DFW Rules Impact Explained" src="docs/images/lab7/Distributed_FW_Explained.png" /><em>Figure 17: DFW Rules Impact Explained</em></p>
<p>Now that we have explained how Distributed Firewalling works across VPCs/VNETs let us attempt to ping azure-log1 from aws-log1.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>student@aws-log1.pod150.aviatrixlab.com<span class="w"> </span>
</pre></div>
</div>
<p><img alt="Ping azure-log1 from aws-log1" src="../_images/ping_aws_log1_azure_log2_post_policy_drop.png" /><em>Figure 18: Ping azure-log1 from aws-log1</em></p>
<p>Ping stops working as expected due to an implicit deny policy.
Let us try to proxy from aws-log1 to azure-log1. This works as per the allowed policy.</p>
<p><img alt="Proxy azure-log1 from aws-log1" src="docs/images/lab7/aws_log1_to_azure_log1_p80_DFW_Inter_Verify.png" /><em>Figure 18: Proxy azure-log1 from aws-log1</em></p>
<p>Below you can see the logs in Policy Monitor for this connection.</p>
<p><img alt="Proxy azure-log1 from aws-log1" src="docs/images/lab7/Policy_Monitor_Inter_VPC.png" /><em>Figure 18: Proxy azure-log1 from aws-log1</em></p>
<p>Now aws-log1 is only allowed to communicate with azure-log1 over HTTP, all other communication with aws-log1 or azure-log1 will be blocked by the virtue of implicit deny.</p>
<p><img alt="DFW Rules Impact Explained" src="../_images/ping_aws_log1_azure_log1_post_policy_drop.png" /><em>Figure 19: Ping azure-log2 from aws-log1</em></p>
<p>Customer-a-client is no longer able to access aws-log1 or azure-log1 but can still access azure-log2 as it is not part of the policy.</p>
<p><img alt="DFW Rules Impact Explained" src="../_images/proxy_customer_a_client_to_aws_log1_or_azure_log1.png" /><em>Figure 20: Proxy customer-a-client to aws-log1 and azure-log1</em></p>
<p><img alt="Proxy customer-a-client to azure-log2" src="../_images/proxy_customer_a_client_to_azure_log2.png" /><em>Figure 21: Proxy customer-a-client to azure-log2</em></p>
</section>
</section>
<section id="distributed-firewalling-intra-vnet">
<h2>7.2 - Distributed Firewalling (Intra-VNET)<a class="headerlink" href="#distributed-firewalling-intra-vnet" title="Permalink to this heading">#</a></h2>
<p>This section shows Intra-VNET segmentation between two Virtual Machines in Azure namely azure-log1 and azure-log2.</p>
<p>We start by logging into the Azure Portal (details are in the lab portal).</p>
<p>We will see the Virtual Machine’s Network Security Group (NSG) configuration of both instances prior to enabling Intra-VNET firewalling.</p>
<p><img alt="Azure-log1 Networking pre-Intra VNET" src="docs/images/lab7/Navigate_Azure_Virtual_Machines.png" /><em>Figure 22: Azure-log1 Networking pre-Intra VNET</em></p>
<p>Please make sure you filter by subscription where your subscription is equal to your pod id.</p>
<p><img alt="Azure-log1 Networking pre-Intra VNET" src="docs/images/lab7/Filter_by_Subscription_.png" /><em>Figure 23: Azure-log1 Networking pre-Intra VNET</em></p>
<p>Figures 24-27 show how you can get the details of the NSGs for azure-log1 &amp; azure-log2 prior to enabling Intra-VNET firewalling.</p>
<p><img alt="Azure-log1 Networking pre-Intra VNET" src="docs/images/lab7/azure_log1_VM_view_view.png" /><em>Figure 24: Azure-log1 Networking pre-Intra VNET</em></p>
<p><img alt="Azure-log1 Networking pre-Intra VNET" src="docs/images/lab7/azure_log1_networking_pre_Intra_VNET.png" /><em>Figure 25: Azure-log1 Networking pre-Intra VNET</em></p>
<p><img alt="Azure-log1 Networking pre-Intra VNET" src="docs/images/lab7/azure_log2_VM_view.png" /><em>Figure 26: Azure-log1 Networking pre-Intra VNET</em></p>
<p><img alt="Azure-log2 Networking pre-Intra VNET" src="docs/images/lab7/azure_log2_networking_pre_Intra_VNET.png" /><em>Figure 27: Azure-log2 Networking pre-Intra VNET</em></p>
<p>Here, we will attempt a connectivity test from azure-log1 to azure-log2 leveraging the proxy.</p>
<p><img alt="azure-log1 to azure-log2 proxy pre-Intra VNET" src="docs/images/lab7/azure_log1_to_azure_log2_pre_Intra_VNET.png" /><em>Figure 28: azure-log1 to azure-log2 proxy pre-Intra VNET</em></p>
<p>Now we will enable Intra-VNET on the azure shared services VNET containing azure-log1 and azure-log2.</p>
<p><img alt="Enable Intra-VNET Part 1" src="docs/images/lab7/DFW_Settings_to_Enable_Intra_VPC.png" /><em>Figure 29: Enable Intra-VNET Part 1</em></p>
<p><img alt="Enable Intra-VNET Part 2" src="docs/images/lab7/Enable_Intra_VNET_P2.png" /><em>Figure 30: Enable Intra-VNET Part 2</em></p>
<p><img alt="Enable Intra-VNET Part 3" src="docs/images/lab7/Enable_Intra_VNET_P3.png" /><em>Figure 31: Enable Intra-VNET Part 3</em></p>
<p><img alt="Enable Intra-VNET Part 4" src="docs/images/lab7/Enable_Intra_VNET_P4.png" /><em>Figure 31: Enable Intra-VNET Part 4</em></p>
<p>Now let us look at the impact of enabling Intra-VNET on the NSGs/ASGs of azure-log1 and azure-log2.</p>
<p>The reason that Azure-log1 has a change in its NSG and is put into an ASG is that it is referenced by policy whereas Azure-log2 remains unaltered.</p>
<p><img alt="Azure-log1 post intra-VNET ASG" src="../_images/azure_log1_application_security_group.png" /><em>Figure 32: Azure_log1 post intra-VNET ASG</em></p>
<p><img alt="Azure-log1 post intra-VNET NSG" src="docs/images/lab7/azure_log1_Azure_NSG_Rule_.png" /><em>Figure 33: Azure-log1 post intra-VNET NSG</em></p>
<p><img alt="Azure-log2 post intra-VNET ASG" src="../_images/azure_log2_application_security_group.png" /><em>Figure 34: Azure-log1 post intra-VNET NSG</em></p>
<p><img alt="Azure-log2 post intra-VNET NSG" src="../_images/azure_log2_nsg.png" /><em>Figure 35: Azure-log2 post intra-VNET ASG</em></p>
<p>Now try accessing azure-log1, you will realize it is no longer reachable. This is due to the last rule in the NSG DenyAllInbound which will block our access as we are trying to access via our own Public addresses.</p>
<p><img alt="Azure-log1 no longer reachable" src="../_images/azure_log1_no_longer_reachable.png" /><em>Figure 36: Azure-log1 no longer reachable</em></p>
<p>To solve this problem, let us create a SmartGroup referencing our public address.</p>
<p><img alt="Home IP SmartGroup" src="docs/images/lab7/home_ip_SmartGroup.png" /><em>Figure 38: Home IP SmartGroup</em></p>
<p>We will now create a rule that allows from traffic from our public address to azure-log1.</p>
<p><img alt="Allow HTTP from Home IP" src="docs/images/lab7/Allow_traffic_from_home_ip_updated.png" /><em>Figure 39: Allow HTTP from Home IP to Azure-log1</em></p>
<p><img alt="Allow HTTP from Home IP P2" src="docs/images/lab7/Allow_traffic_from_home_ip_updated_p2.png" /><em>Figure 39: Allow HTTP from Home IP to Azure-log1 Part 2</em></p>
<p>Now, we can see the NSG for azure-log1 got updated with a rule allowing traffic from our public address. Please note that the public address you will have in your setup will be different than the screenshot.</p>
<p><img alt="Azure-log1 NSG Updates" src="../_images/azure_log1_nsg_home_ip_rule_.png" /><em>Figure 40: Azure-log1 NSG Updates</em></p>
<p>Now you should be able to recover access to azure-log1 and you can attempt to proxy from azure-log1 to azure-log2. This should work as azure-log2 has no inbound policy preventing the access, however attempting to proxy from azure-log2 to azure-log1 will not succeed due to rule 4095 which blocks traffic from 10.2.0.0/16 to 10.2.0.0/16.</p>
<p><img alt="Allow HTTP from Home IP" src="../_images/proxy_azure_log1_to_log2_all_good.png" /><em>Figure 42: Allow HTTP from Home IP</em></p>
<p><img alt="Allow HTTP from Home IP" src="docs/images/lab7/Proxy_from_azure_log2_to_azure_log1.png" /><em>Figure 42: Allow HTTP from Home IP</em></p>
<p>Now our objective is to close down the communication from azure-log1 to azure-log2. Let’s check if ping is allowed. Let’s SSH to azure-log1 and try to ping azure-log2.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>student@azure-log1.pod150.aviatrixlab.com
</pre></div>
</div>
<p>SSH is not working due to the fact that we only allowed HTTP from our public address.</p>
<p><img alt="Allow SSH from Home IP" src="docs/images/lab7/Allow_from_home_ip_to_azure_log1_SSH_P2.png" /><em>Figure 42: Allow SSH from Home IP Part 1</em></p>
<p><img alt="Allow HTTP from Home IP" src="docs/images/lab7/Allow_from_home_ip_to_azure_log1_SSH_P1.png" /><em>Figure 42: Allow SSH from Home IP Part 2</em></p>
<p><img alt="Allow HTTP from Home IP" src="docs/images/lab7/ping_from_azure_log1_to_azure_log2_OPEN.png" /><em>Figure 43: Allow HTTP from Home IP Part 2</em></p>
<p>To close this down, we will be putting a rule from azure-log1 to azure-log2 that only allows HTTP traffic.</p>
<p><img alt="Allow HTTP from azure-log1 to azure-log2" src="docs/images/lab7/Allow_from_azure_log1_to_azure_log2_tcp_80_p1.png" /><em>Figure 43: Allow HTTP from Home IP Part 2</em></p>
<p><img alt="Allow HTTP from azure-log1 to azure-log2" src="docs/images/lab7/Allow_from_azure_log1_to_azure_log2_tcp_80_p2.png" /><em>Figure 42: Allow HTTP from Home IP</em></p>
<p><img alt="Ping Blocked after Policy" src="../_images/ping_from_azure_log1_to_azure_log2_blocked_after_p80.png" /><em>Figure 42: Allow HTTP from Home IP</em></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="lab6.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lab 6 Advanced Routing &amp; Resiliency</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-s-in-the-lab">7.0 - What’s in the lab?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#distributed-firewalling-inter-vpc-vnet">7.1 - Distributed Firewalling (Inter-VPC/VNET)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#smart-group-creation">7.1.1  - Smart Group Creation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-dfw-connectivity-test">7.1.2  - Pre-DFW Connectivity Test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distributed-firewall-rule">7.1.3  - Distributed Firewall Rule</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#zooming-in-on-the-dfw-rule">7.1.4  - Zooming in on the DFW Rule</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#distributed-firewalling-intra-vnet">7.2 - Distributed Firewalling (Intra-VNET)</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Aviatrix ACE
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>