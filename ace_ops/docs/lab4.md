# Lab 4 - FireNet - Routes

## 1. SCENARIO

**BU1** and **BU2** were able to communicate as end of Lab3.

Unfortunately, the network team received another complaint from BU1 Frontend Team that BU2 Mobile App was no longer reachable.

```{figure} images/lab4-topology.png
---
height: 400px
align: center
---
Lab 4 Topology
```

## 2. TROUBLESHOOT REQUEST

Let’s move forward with the troubleshooting. Verify the connectivity between **BU1 Frontend** and **BU2 Mobile App**.

### 2.1 Connectivity verification Using Gatus

Analyze the **BU1 Frontend** Gatus dashboard again: traffic to the BU2 Mobile App is blocked, and traffic to the other instances is blocked as well. All checks are turning red.

```{figure} images/lab3-4.28.diagnosticstools11901.png
---
height: 400px
align: center
---
All types of traffic are blocked
```

### 2.2 Connectivity verification Using Diagnostic Tools

Remember that all Aviatrix gateways include built-in enterprise-grade tools, such as ping and traceroute. Run these commands directly from the `Diagnostic Tools` section.

From _ace-aws-eu-west-1-spoke1_, ping the private IP address of **BU2 Mobile App** and perform a traceroute.

```{figure} images/lab4-traceroute280.png
---
align: center
---
Ping from the Spoke1
```

```{figure} images/lab4-traceroute283.png
---
align: center
---
Traceroute from the Spoke1
```

This time, one hop—the Transit Gateway—has responded.

Repeat this operation: from the _ace-aws-eu-west-1-spoke2_ Spoke GW, try to ping the private IP address of the BU1 Frontend too.

- Now try to ping both workloads (i.e. BU1 Frontend and BU2 Mobile App) from the **Transit** GW in AWS.

```{figure} images/lab3-bu1ping.png
---
align: center
---
Ping is ok from the Transit GW towards BU1 Frontend
```

```{figure} images/lab3-bu2ping.png
---
align: center
---
Ping is ok from the Transit GW towards BU2 Mobile App
```

From the outcome above, you can notice that the Transit GW in AWS can ping both BU1 Frontend and BU2 Mobile App, successfully.

```{important}
The Transit Gateway is now responding to the traceroute, which suggests that the traffic path is no longer being dropped as it was in the previous lab.
```

### 2.3 Connectivity verification Using SSH client <span style='color:#33ECFF'>(BONUS)</span></summary>

- Verify that the connectivity between **BU1 Frontend** and **BU2 Mobile App** is actually broken.

  - SSH to BU1 Frontend and launch ping/traceroute to BU2 Mobile App.

```{figure} images/lab4-pingunsucc.png
---
align: center
---
Ping fails
```

```{figure} images/lab4-pingunsucc00.png
---
align: center
---
Traceroute outcome
```

### 2.4 Routing Tables verification

- Check whether both **AWS Spoke1** and **AWS Spoke2** have the required routes installed in their RTBs or not.

```{tip}
Navigate to **CoPilot > Cloud Fabric > Gateways > Spoke Gateways >** select the **ace-aws-eu-west-1-spoke1** gateway for instance, and filter by the remote route (i.e., 10.1.212.0/24)
```

```{figure} images/lab4-filter.png
---
height: 300px
align: center
---
Filter
```

From the outcome above, once again it is evident that Spoke1 in AWS has the destination route in its RTB.

Verify the reverse path by checking that the **AWS Spoke2 gateway** has a route to reach BU1 Frontend.

### 2.5 FireNet section

- Let's check the **FireNet** section!

```{tip}
Navigate to **CoPilot > Security > FireNet**
```

```{figure} images/lab4-firewallok.png
---
height: 150px
align: center
---
The FW is UP
```

```{note}
This time the FW is responding properly to the **Health Check** mechanism, therefore we can't blame the Security Team.

The Firewall is reachable from the Transit FireNet GW!
```

#### 2.5.1 Connectivity test Using the Diagnostic Tools

Navigate to **CoPilot > Diagnostics > Diagnostic Tools** and run a traceroute from the **_ace-aws-eu-west-1-spoke1_** gateway to the private IP of the **BU2 Mobile App**.

```{figure} images/lab4-firewallok9901.png
---
height: 300px
align: center
---
Traceroute
```

Notice that the Transit Gateway is now responding to the UDP traceroute traffic—a distinct change from the previous scenario. Next, perform a packet capture on the **_ace-aws-eu-west-1-transit1_** Gateway using egress interface `'eth-fn0'` (which connects to the Firewall).

```{figure} images/lab4-firewallok99.png
---
height: 300px
align: center
---
Packet Capture
```

```{figure} images/lab4-firewallok9902.png
---
height: 300px
align: center
---
Traceroute Outcome
```

Analyze the traceroute output (feel free to filter on the keyword `“ICMP”`). You should see the ICMP Echo Request packets generated by the **BU1 Frontend**, but you will not see the corresponding ICMP Echo Reply that should be returned by the **BU2 Mobile App**.

In addition to the Echo Requests sent by the **BU1 Frontend**, you may also see other ICMP Echo Request/Echo Reply packets generated by FireNet’s health-check mechanism. These packets are typically sent by the Transit Gateway and the firewall.

#### 2.5.2 Connectivity test Using SSH client <span style='color:#33ECFF'>(BONUS)</span></summary>

- Please keep sending ping requests from the **BU1 Frontend** to the **BU2 Mobile App**, noting that the results are expected to fail.

```{figure} images/lab4-keepit.png
---
align: center
---
Keep the ping running...
```

```{tip}
You can also generate ICMP traffic from the Spoke gateway using **Diagnostics > Diagnostic Tools**.
```

- Proceed to start a _packet capture_ on the `eth-fn0` interface of the **Transit FireNet GW**.

```{important}
The **eth-fn0** interface is hooked up to the **LAN** interface of the Firewall, within the **_transit1-dmz-firewall_** subnet!
```

```{tip}
Navigate to **CoPilot > Diagnostics > Diagnostic Tools > Gateway Diagnostics**, select the **_ace-aws-eu-west-1-transit1_** GW, choose the `Packet Capture` tool, set the capture duration to 10 seconds, and then click **"Run"**.

```{figure} images/lab4-packet1.png
---
height: 250px
align: center
---
Packet Capture
```

Select the `"Column filter"` icon and **deselect** the listed parameters. Because you’re gathering **_ICMP traffic_**, only the relevant fields are needed:

  - <span style='color:#479608'>Uncheck Source Port</span>
  - <span style='color:#479608'>Uncheck Dest Port</span>
  - <span style='color:#479608'>Uncheck Flags</span>
  - <span style='color:#479608'>Uncheck Length</span>
  
```{figure} images/lab4-packet2.png
---
align: center
---
Restrict the visibility of the Packet Capture to the required parameters
```

```{figure} images/lab4-packet3.png
---
height: 400px
align: center
---
Outcome of the Packet capture
```

```{important}
The health check shows the echo request and echo reply exchanged between the Transit Gateway and the NGFW, but only the BU1 Frontend’s echo request is reaching the NGFW. The NGFW is not forwarding the traffic back, and the echo request is dropped there.
```

```{caution}
This time the firewall is reachable!
```

### 2.6 Vendor Integration

- Let's check the `Vendor Integration`!

```{tip}
Navigate to **CoPilot > Security > FireNet > Firewall**, click on the **_ACE-FW_** firewall.
```

```{figure} images/lab4-vendor1.png
---
height: 350px
align: center
---
10.0.0.0/8 is not installed in the RTB of the FW
```

```{note}
It will be immediately evident that the `10.0.0.0/8` **RFC1918 route**  has been removed (one of the three RFC1918 routes)
```

- Click the `"Sync Routes to Firewall"` button to initiate the **Vendor Integration**. The **Aviatrix Controller** will reinject the missing route into the firewall's routing table.

```{figure} images/lab4-vendor2.png
---
align: center
---
10.0.0.0/8 has been successfully reinjected into the FW's rtb!
```

### 2.7 Final Verification

The firewall didn’t have a route for the return traffic (i.e., its routing table was missing the 10.0.0.0/8 route), so the firewall was dropping the traffic. After the vendor integration and synchronization of the RFC1918 routes, we’ve verified that connectivity has been restored.

#### 2.7.1 Connectivity test Using Gatus

Check the Gatus dashboard for **BU1 Frontend**.

```{figure} images/lab3-4.28.diagnosticstools11901r4.png
---
height: 400px
align: center
---
Traffic is back to normal
```

#### 2.7.2 Connectivity test Using the Diagnostic Tools

From Diagnostic Tools, run the ping command from the **_ace-aws-eu-west-1-spoke1_** gateway to the private IP address of the **BU2 Mobile App**. This time, the ping should succeed.

```{figure} images/lab3-4.28.diagnosticstools11901r41.png
---
height: 400px
align: center
---
ping is ok!
```

#### 2.7.3 Connectivity test Using SSH client <span style='color:#33ECFF'>(BONUS)</span></summary>

- Re-run ping to the MobileApp instance’s private IP address from AWS Spoke1, using the `Diagnostic Tools`.

```{figure} images/lab4-traceroute281.png
---
align: center
---
Ping from the Spoke1
```

- Alternatively, re-execute the ping from **BU1 Frontend** toward **BU2 Mobile App**.

```{figure} images/lab4-pingworks.png
---
align: center
---
Ping is ok
```
