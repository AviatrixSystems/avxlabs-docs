name: deploy-book

on:
  pull_request:
    types:
      - review_requested
      - synchronize # Checks any commits made to the PR

# This job installs dependencies, builds the book, and pushes it to `gh-pages`
jobs:
  deploy-book:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: Stockopedia/action-get-changed-files@v1
        id: changed_folders
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          ignore: "**/+(.github)"
          foldersOnly: true
          format: newline
      - name: Echo changed files
        run: echo ${{ steps.get_changed.outputs.changed }}

      # Install dependencies
      - name: Set up Python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: setup git config
        run: |
          # setup the username and email. I tend to use 'GitHub Actions Bot' with no email by default
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"

      - name: Loop and Run Jupyter Book
        run: |
          PR_FILES=${{ steps.changed_folders.outputs.changed }}
          for FILE in $PR_FILES; do
            if [[ "$FILE" == *"_"* ]]; then
              cd $FILE
              jupyter-book build .
              cd -
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        # Push the book's HTML to github-pages
      - name: GitHub Pages action
        uses: peaceiris/actions-gh-pages@v3.6.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
